version: '3.8'

# High Availability Configuration
# This extends docker-compose.yml with HA features

services:
  # Backend Instance 1
  backend-1:
    extends:
      service: backend
    container_name: digital_utopia_backend_1
    environment:
      - INSTANCE_ID=1
    deploy:
      replicas: 1

  # Backend Instance 2
  backend-2:
    extends:
      service: backend
    container_name: digital_utopia_backend_2
    environment:
      - INSTANCE_ID=2
    deploy:
      replicas: 1

  # PostgreSQL Primary (Master)
  postgres-primary:
    extends:
      service: postgres
    container_name: digital_utopia_postgres_primary
    environment:
      - POSTGRES_REPLICATION_MODE=master
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=${POSTGRES_REPLICATION_PASSWORD:-replicator_password}
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
      -c hot_standby=on

  # PostgreSQL Replica (Standby)
  postgres-replica:
    image: timescale/timescaledb:latest-pg15
    container_name: digital_utopia_postgres_replica
    environment:
      POSTGRES_MASTER_HOST: postgres-primary
      POSTGRES_MASTER_PORT: 5432
      POSTGRES_REPLICATION_MODE: slave
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD:-replicator_password}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
    networks:
      - digital_utopia_network
    depends_on:
      - postgres-primary
    restart: always
    command: >
      bash -c "
      until pg_basebackup -h postgres-primary -D /var/lib/postgresql/data -U replicator -v -P -W; do
        echo 'Waiting for primary to be available...'
        sleep 1s
      done
      echo 'standby_mode = '\''on'\''' >> /var/lib/postgresql/data/postgresql.conf
      echo 'primary_conninfo = '\''host=postgres-primary port=5432 user=replicator password=replicator_password'\''' >> /var/lib/postgresql/data/postgresql.conf
      postgres
      "

  # Redis Sentinel
  redis-sentinel-1:
    image: redis:7-alpine
    container_name: digital_utopia_redis_sentinel_1
    command: redis-sentinel /etc/redis/sentinel.conf
    volumes:
      - ./redis/sentinel.conf:/etc/redis/sentinel.conf:ro
    networks:
      - digital_utopia_network
    depends_on:
      - redis
    restart: always

  redis-sentinel-2:
    image: redis:7-alpine
    container_name: digital_utopia_redis_sentinel_2
    command: redis-sentinel /etc/redis/sentinel.conf
    volumes:
      - ./redis/sentinel.conf:/etc/redis/sentinel.conf:ro
    networks:
      - digital_utopia_network
    depends_on:
      - redis
    restart: always

  redis-sentinel-3:
    image: redis:7-alpine
    container_name: digital_utopia_redis_sentinel_3
    command: redis-sentinel /etc/redis/sentinel.conf
    volumes:
      - ./redis/sentinel.conf:/etc/redis/sentinel.conf:ro
    networks:
      - digital_utopia_network
    depends_on:
      - redis
    restart: always

  # Nginx Load Balancer
  nginx-loadbalancer:
    image: nginx:alpine
    container_name: digital_utopia_nginx_loadbalancer
    volumes:
      - ./nginx/nginx-ha.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8080:80"
      - "8443:443"
    networks:
      - digital_utopia_network
    depends_on:
      - backend-1
      - backend-2
    restart: always

volumes:
  postgres_replica_data:
    driver: local
