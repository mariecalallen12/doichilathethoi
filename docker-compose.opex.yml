# OPEX Core Integration
# This file integrates OPEX trading system services with the existing backend
# Run with: docker-compose -f docker-compose.yml -f docker-compose.opex.yml up -d

version: '3.8'

# Use the same network as main docker-compose
networks:
  default:
    external: false
  opex:
    driver: bridge
    name: opex-network
  digital_utopia_network:
    external: true
    name: forexxx_digital_utopia_network

# Import OPEX services from core-main
# Note: This is a simplified version - full integration requires copying core-main/docker-compose.yml
# and adapting it to work with the existing infrastructure

services:
  # OPEX Infrastructure Services
  opex-zookeeper:
    image: confluentinc/cp-zookeeper:7.1.1
    hostname: opex-zookeeper
    container_name: opex-zookeeper
    volumes:
      - opex-zookeeper-data:/var/lib/zookeeper/data
      - opex-zookeeper-log:/var/lib/zookeeper/log
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
      - ZOOKEEPER_CLIENT_PORT=2181
    networks:
      - opex
    ports:
      - "2181:2181"
    deploy:
      restart_policy:
        condition: on-failure

  opex-kafka-1:
    image: ghcr.io/opexdev/kafka
    hostname: opex-kafka-1
    container_name: opex-kafka-1
    volumes:
      - opex-kafka-1:/var/lib/kafka/data
    environment:
      - KAFKA_ZOOKEEPER_CONNECT=opex-zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CLIENT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_LISTENERS=CLIENT://opex-kafka-1:29092,EXTERNAL://opex-kafka-1:9092
      - KAFKA_ADVERTISED_LISTENERS=CLIENT://opex-kafka-1:29092,EXTERNAL://opex-kafka-1:9092
      - KAFKA_INTER_BROKER_LISTENER_NAME=CLIENT
      - KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE=false
    depends_on:
      - opex-zookeeper
    networks:
      - opex
    ports:
      - "9092:9092"
    deploy:
      restart_policy:
        condition: on-failure

  opex-redis:
    image: redis:7-alpine
    container_name: opex-redis
    command: redis-server --appendonly yes
    volumes:
      - opex-redis-data:/data
    environment:
      - REDIS_REPLICATION_MODE=master
    networks:
      - opex
    ports:
      - "6380:6379"  # Changed to avoid conflict with main redis
    deploy:
      restart_policy:
        condition: on-failure

  # OPEX Core Services
  opex-matching-engine:
    image: ghcr.io/opexdev/matching-engine
    container_name: opex-matching-engine
    environment:
      - JAVA_OPTS=-Xmx256m
      - KAFKA_IP_PORT=opex-kafka-1:29092
      - REDIS_HOST=opex-redis
      - SYMBOLS=BTC_USDT,ETH_USDT,BTC_IRT,ETH_IRT,USDT_IRT,ETH_BUSD,BTC_BUSD,BNB_BUSD
      - PREFERENCES=preferences-demo.yml
    depends_on:
      - opex-kafka-1
      - opex-redis
    networks:
      - opex
    deploy:
      restart_policy:
        condition: on-failure

  opex-matching-gateway:
    image: ghcr.io/opexdev/matching-gateway
    container_name: opex-matching-gateway
    environment:
      - JAVA_OPTS=-Xmx256m
      - KAFKA_IP_PORT=opex-kafka-1:29092
      - CONSUL_HOST=opex-consul
    depends_on:
      - opex-kafka-1
      - opex-matching-engine
    networks:
      - opex
    ports:
      - "8081:8080"  # Matching gateway API
    deploy:
      restart_policy:
        condition: on-failure

  opex-api:
    image: ghcr.io/opexdev/api
    container_name: opex-api
    environment:
      - JAVA_OPTS=-Xmx512m
      - CONSUL_HOST=opex-consul
      - DB_IP_PORT=opex-postgres-api
      - dbusername=${OPEX_DB_USER:-opex}
      - dbpassword=${OPEX_DB_PASS:-hiopex}
      - BACKEND_USER=${OPEX_BACKEND_USER:-opex}
      - VAULT_HOST=opex-vault
      - SWAGGER_AUTH_URL=${OPEX_KEYCLOAK_FRONTEND_URL:-http://localhost:8083/auth}
      - PREFERENCES=preferences-demo.yml
      - API_KEY_CLIENT_SECRET=${OPEX_API_KEY_CLIENT_SECRET:-x}
    depends_on:
      - opex-matching-gateway
      - opex-postgres-api
    networks:
      - opex
      - digital_utopia_network
    ports:
      - "8082:8080"  # OPEX API
    deploy:
      restart_policy:
        condition: on-failure

  opex-market:
    image: ghcr.io/opexdev/market
    container_name: opex-market
    environment:
      - JAVA_OPTS=-Xmx512m
      - KAFKA_IP_PORT=opex-kafka-1:29092
      - CONSUL_HOST=opex-consul
      - DB_IP_PORT=opex-postgres-market
      - dbusername=${OPEX_DB_USER:-opex}
      - dbpassword=${OPEX_DB_PASS:-hiopex}
      - BACKEND_USER=${OPEX_BACKEND_USER:-opex}
      - VAULT_HOST=opex-vault
      - SWAGGER_AUTH_URL=${OPEX_KEYCLOAK_FRONTEND_URL:-http://localhost:8083/auth}
      - PREFERENCES=preferences-demo.yml
    depends_on:
      - opex-kafka-1
      - opex-postgres-market
    networks:
      - opex
      - digital_utopia_network
    ports:
      - "8083:8080"  # Market service
    deploy:
      restart_policy:
        condition: on-failure

  opex-wallet:
    image: ghcr.io/opexdev/wallet
    container_name: opex-wallet
    environment:
      - JAVA_OPTS=-Xmx512m
      - KAFKA_IP_PORT=opex-kafka-1:29092
      - CONSUL_HOST=opex-consul
      - DB_IP_PORT=opex-postgres-wallet
      - dbusername=${OPEX_DB_USER:-opex}
      - dbpassword=${OPEX_DB_PASS:-hiopex}
      - BACKEND_USER=${OPEX_BACKEND_USER:-opex}
      - VAULT_HOST=opex-vault
      - SWAGGER_AUTH_URL=${OPEX_KEYCLOAK_FRONTEND_URL:-http://localhost:8083/auth}
      - PREFERENCES=preferences-demo.yml
    depends_on:
      - opex-kafka-1
      - opex-postgres-wallet
    networks:
      - opex
    ports:
      - "8084:8080"  # Wallet service
    deploy:
      restart_policy:
        condition: on-failure

  # Supporting services (simplified - full setup requires more configuration)
  opex-consul:
    image: hashicorp/consul
    container_name: opex-consul
    environment:
      - CONSUL_BIND_INTERFACE=eth0
    networks:
      - opex
    ports:
      - "8500:8500"
    deploy:
      restart_policy:
        condition: on-failure

  opex-vault:
    image: ghcr.io/opexdev/vault-opex
    container_name: opex-vault
    cap_add:
      - IPC_LOCK
    environment:
      - VAULT_ADDR=http://0.0.0.0:8200
      - PANEL_PASS=${OPEX_PANEL_PASS:-admin}
      - BACKEND_USER=${OPEX_BACKEND_USER:-opex}
      - VAULT_DISABLE_MLOCK=true
    networks:
      - opex
    ports:
      - "8200:8200"
    deploy:
      restart_policy:
        condition: on-failure

  # PostgreSQL databases for OPEX services
  opex-postgres-api:
    image: ghcr.io/opexdev/postgres-opex
    container_name: opex-postgres-api
    environment:
      - POSTGRES_USER=${OPEX_DB_USER:-opex}
      - POSTGRES_PASSWORD=${OPEX_DB_PASS:-hiopex}
      - POSTGRES_DB=${OPEX_DB_USER:-opex}
    networks:
      - opex
    volumes:
      - opex-postgres-api-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    deploy:
      restart_policy:
        condition: on-failure

  opex-postgres-market:
    image: ghcr.io/opexdev/postgres-opex
    container_name: opex-postgres-market
    environment:
      - POSTGRES_USER=${OPEX_DB_USER:-opex}
      - POSTGRES_PASSWORD=${OPEX_DB_PASS:-hiopex}
      - POSTGRES_DB=${OPEX_DB_USER:-opex}
    networks:
      - opex
    volumes:
      - opex-postgres-market-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    deploy:
      restart_policy:
        condition: on-failure

  opex-postgres-wallet:
    image: ghcr.io/opexdev/postgres-opex
    container_name: opex-postgres-wallet
    environment:
      - POSTGRES_USER=${OPEX_DB_USER:-opex}
      - POSTGRES_PASSWORD=${OPEX_DB_PASS:-hiopex}
      - POSTGRES_DB=${OPEX_DB_USER:-opex}
    networks:
      - opex
    volumes:
      - opex-postgres-wallet-data:/var/lib/postgresql/data
    ports:
      - "5435:5432"
    deploy:
      restart_policy:
        condition: on-failure

volumes:
  opex-zookeeper-data:
  opex-zookeeper-log:
  opex-kafka-1:
  opex-redis-data:
  opex-postgres-api-data:
  opex-postgres-market-data:
  opex-postgres-wallet-data:

